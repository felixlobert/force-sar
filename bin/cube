#!/usr/bin/python3

import os
from glob import glob

import click

from src import utils


@click.command()
@click.argument("prm_file", type=click.Path(exists=True))
def cube(prm_file):
    """Cube processed S1 data into existing data cube as specified in PRM_FILE"""

    prm = utils.read_prm(prm_file)

    acquisitions = next(os.walk(prm["DIR_LEVEL1"]))[2]
    acquisitions = [i.split("_GAM")[0] for i in acquisitions]
    acquisitions = sorted([*{*acquisitions}])

    mosaic_path = os.path.join(prm["DIR_LEVEL1"], "mosaic")

    if not os.path.exists(mosaic_path):
        os.mkdir(mosaic_path)

    for acquisition in acquisitions:
        mosaic_name = os.path.join(mosaic_path, acquisition + "_GAM.vrt")

        if os.path.exists(mosaic_name):
            continue

        vrt_cmd = "gdalbuildvrt"
        vrt_cmd += " -vrtnodata -9999 -srcnodata -9999 "
        vrt_cmd += mosaic_name + " "
        vrt_cmd += " ".join(
            glob(os.path.join(prm["DIR_LEVEL1"], acquisition + "*.tif"))
        )
        os.system(vrt_cmd)

        cube_cmd = "force-cube"
        cube_cmd += " -o " + prm["DIR_LEVEL2"]
        cube_cmd += " -n -9999 -t Int16 -r near"
        cube_cmd += " -j " + prm["NTHREAD"] + " -s " + prm["RESOLUTION"]
        cube_cmd += " " + mosaic_name
        os.system(cube_cmd)


if __name__ == "__main__":
    cube()
